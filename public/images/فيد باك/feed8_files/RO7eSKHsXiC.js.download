;/*FB_PKG_DELIM*/

__d("MAWDeanonComparisonExtensionStep",["EBDeanonRangeExtension","asyncToGeneratorRuntime","nullthrows"],(function(a,b,c,d,e,f,g){"use strict";a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.chatJid,e=a.count,f=a.db,g=a.direction,h=a.dispatch,i=a.logger,j=a.oldRange,k=a.oldRangeExternalIds;a=a.prevResponse;a=c("nullthrows")(a,"Prev response should not be null for subsequent steps");b=(yield d("EBDeanonRangeExtension").getRangeFromLocalDataIfConsistent({chatJid:b,db:f,direction:g,dispatch:h,logger:i,pageSize:e,range:j,rangeExternalIds:k}));if(b!=null){i==null?void 0:i.addQPLAnnotations({string:{eb_restore_status:"skipped"}});return{extension:a,status:"complete"}}return{extension:a,status:"continue"}});return function(b){return a.apply(this,arguments)}}();e=a;g["default"]=e}),98);
__d("MAWEBRestoreExtensionStep",["FBLogger","I64","MAWFetchMessagesForMLv2","MAWFetchMessagesFromEBForMLv2","MAWFindMsgsWithMinAndMaxTimestamp","MAWMessagesDirection","MAWMessagesRangesUtils","asyncToGeneratorRuntime","nullthrows"],(function(a,b,c,d,e,f,g){"use strict";var h,i=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.chatJid,e=a.count,f=a.db,g=a.direction,i=a.logger,j=a.oldRange,k=a.oldRangeExternalIds;a=a.prevResponse;a=c("nullthrows")(a);f=(yield c("MAWFetchMessagesFromEBForMLv2")({chatJid:b,db:f,direction:g,logger:i,pageSize:e,range:j}));if(f.success===!1)return{extension:a,status:"complete"};i=(yield d("MAWFetchMessagesForMLv2").fetchMessagesFromMAW({chatJid:b,direction:g,includeOriginalMsg:!1,pageSize:e,range:j}));if(i.success===!1){c("FBLogger")("messenger_web_product").mustfix("Failed to fetch messages from MAW after successful EB restore");return{extension:a,status:"complete"}}b=i.value;var l=f.value.recovered;e=l.messages;a=e.map(function(a){return a.sortOrderMs}).filter(Boolean);i=[Math.min.apply(Math,a),Math.max.apply(Math,a)];f=i[0];a=i[1];i=d("MAWMessagesDirection").getI64RangeTimestampForDirection(g,j);f=g==="desc"?[(h||(h=d("I64"))).of_float(f),i]:[i,(h||(h=d("I64"))).of_float(a)];var m=f[0],n=f[1];i=b.msgs.filter(function(a){return(h||(h=d("I64"))).ge((h||(h=d("I64"))).of_float(a.sortOrderMs),m)&&(h||(h=d("I64"))).le((h||(h=d("I64"))).of_float(a.sortOrderMs),n)});a=babelHelpers["extends"]({},b,{hasMoreAfter:b.hasMoreAfter||l.hasMoreAfter,hasMoreBefore:b.hasMoreBefore||l.hasMoreBefore,msgs:i});f=i.length===0||l.isEndOfCurrentFormat;if(!f)return{extension:a,status:"complete"};var o,p;if(i.length===0){c("FBLogger")("messenger_web_product").mustfix("EBMessageRangeDataSource: No local messages found within EB response range for protobuf. Filtered EB payload size: %s, original EB payload size: %s, original EB hasMoreBefore: %s, original EB hasMoreAfter: %s",e.length,l.messages.length,l.hasMoreBefore,l.hasMoreAfter);b=d("MAWFindMsgsWithMinAndMaxTimestamp").findEBMsgsWithMinAndMaxTimestamp(e);o=b[0];p=b[1]}else{f=d("MAWFindMsgsWithMinAndMaxTimestamp").findMsgsWithMinAndMaxTimestamp(i);o=f[0];p=f[1]}e=babelHelpers["extends"]({},j,function(){switch(g){case"asc":var a,b;a=(a=(a=p)==null?void 0:a.msgId)!=null?a:j.maxMessageId;b=(h||(h=d("I64"))).max(j.maxTimestampMs,((b=p)==null?void 0:b.sortOrderMs)!=null?(h||(h=d("I64"))).of_float((b=p)==null?void 0:b.sortOrderMs):j.maxTimestampMs);if(l.hasMoreAfter===!0){var e=!1;(h||(h=d("I64"))).equal(j.maxTimestampMs,b)&&j.maxMessageId===a?(c("FBLogger")("messenger_web_product").mustfix("EBMessageRangeDataSource: stuck in the same max timestamp: %s",(h||(h=d("I64"))).to_string(b)),e=!0,b=h.add(b,h.of_int32(1))):l.isEndOfCurrentFormat===!0&&(e=!0);e&&(b=(h||(h=d("I64"))).equal(b,(h||(h=d("I64"))).max_int)?b:(h||(h=d("I64"))).add(b,(h||(h=d("I64"))).of_int32(1)))}return{hasMoreAfter:l.hasMoreAfter,isLoadingAfter:!1,maxMessageId:a,maxTimestampMs:b};case"desc":b=(a=(e=o)==null?void 0:e.msgId)!=null?a:j.minMessageId;e=(h||(h=d("I64"))).min(j.minTimestampMs,((e=o)==null?void 0:e.sortOrderMs)!=null?(h||(h=d("I64"))).of_float((a=o)==null?void 0:a.sortOrderMs):j.minTimestampMs);if(l.hasMoreBefore===!0){a=!1;(h||(h=d("I64"))).equal(j.minTimestampMs,e)&&j.minMessageId===b?(c("FBLogger")("messenger_web_product").mustfix("EBMessageRangeDataSource: stuck in the same min timestamp: %s",(h||(h=d("I64"))).to_string(e)),a=!0):l.isEndOfCurrentFormat===!0&&(a=!0);a&&(e=(h||(h=d("I64"))).equal(e,(h||(h=d("I64"))).min_int)?e:(h||(h=d("I64"))).sub(e,(h||(h=d("I64"))).of_int32(1)))}return{hasMoreBefore:l.hasMoreBefore,isLoadingBefore:!1,minMessageId:b,minTimestampMs:e}}}());b=d("MAWMessagesRangesUtils").getNewMsgsRangesExternalIds(g,o,p,k);return{extension:a,status:"complete_with_range_override",updatedRange:e,updatedRangeExternalIds:b}});return function(b){return a.apply(this,arguments)}}();function a(a){var c=a.onEBFailure;return function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=(yield i(a));if(a.status==="eb_failed"){c();return{extension:a.extension,status:"complete"}}return a});return function(b){return a.apply(this,arguments)}}()}g.createEBRestoreExtensionStep=a}),98);
__d("MAWLocalDBExtensionStep",["MAWFetchMessagesForMLv2","MAWTimedBridge","WATagsLogger","asyncToGeneratorRuntime","err"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["MAWMessageRangeDataSource: Failed to fetch messages from worker due to ",". Error: ",""]);h=function(){return a};return a}a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.chatJid,e=a.count,f=a.direction;a=a.oldRange;b=(yield d("MAWFetchMessagesForMLv2").fetchMessagesFromMAW({chatJid:b,direction:f,includeOriginalMsg:!0,pageSize:e,range:a}));if(b.success===!1){f=b.payload;e=f==null?"unknown":"["+f.name+"]: "+f.message;d("WATagsLogger").TAGS(["maw_message_core","MAWMessageRangeDataSource"]).ERROR(h(),b.error,e);if(b.payload instanceof d("MAWTimedBridge").MAWBridgeTimeoutError)return{status:"try_again"};throw(a=b.payload)!=null?a:c("err")("Failed to fetch messages from worker")}return{extension:b.value,status:"continue"}});return function(b){return a.apply(this,arguments)}}();e=a;g["default"]=e}),98);
__d("MAWRangeExtensionDataConverter",["I64","MAWBridgeNewMsgHandler","MAWBridgeNewReceiverFetchInfoHandler","MAWDbMsg","MAWMediaUIConverter","MAWMessageUIConverter","MAWMsg","MAWMsgReplySnippet","MAWReactionUIConverter","MAWXMAUIConvertor","nullthrows","qex"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b){var e=b.msgs,f=b.reactions,g=b.medias,i=b.expiringCountdown,j=b.xmas,k=b.receiverFetchInfoPayloads;return e.map(function(b){var e,l=d("MAWBridgeNewMsgHandler").composeMessage(a,b,d("MAWMessageUIConverter").getAdminMsgCTA(b),d("MAWMsgReplySnippet").getReplySnippet(b));b=i.find(function(a){return a.msgId===l.messageId});b!=null&&(l=babelHelpers["extends"]({},l,{ephemeralExpirationTs:(h||(h=d("I64"))).of_float(b.countdownTs)}));b=(b=c("qex")._("1599"))!=null?b:!1;if(!b)return{associatedData:{attachmentData:{attachmentCTAs:[],attachmentItems:[],attachments:[]},reactions:[]},message:l};b=f.filter(function(a){return a.type==="upsert"}).filter(function(a){return a.reaction.messageId===l.messageId}).map(function(b){b=b.reaction;return d("MAWReactionUIConverter").bridgeToLS(b,a)});var m=c("nullthrows")(d("MAWDbMsg").toMsgId(l.messageId)),n=[],o=[];if(d("MAWMsg").isXMAMsg(l)&&((e=c("qex")._("1595"))!=null?e:!1)){e=j.find(function(a){return a.msgId===m});if(e){var p=String(e.xmaId),q=d("MAWXMAUIConvertor").bridgeXMAtoLSAttachmentCTAs(e,p,m,a);e=d("MAWXMAUIConvertor").bridgeXMAtoLSAttachment(e,p,m,a,q);o=[q];n=[e]}}else d("MAWMsg").isReceiverFetchMsg(l)?n=k.filter(function(a){return a.msgId===m}).map(function(b){return d("MAWBridgeNewReceiverFetchInfoHandler").composeAttachment(b,a,null)}):d("MAWMsg").isMediaMsg(l)&&(n=g.filter(function(a){return a.msgIds.indexOf(m)!==-1}).map(function(b){return d("MAWMediaUIConverter").bridgeToLS(a,b,m)}));return{associatedData:{attachmentData:{attachmentCTAs:o,attachmentItems:[],attachments:n},reactions:b},message:l}})}g.convertLocalResponseToMessages=a}),98);
__d("MAWMessageRangeDataSourceV2",["FBLogger","I64","LSDatabaseSingleton","LSEncryptedBackupsBackupTenancy","LSIntEnum","MAWDeanonComparisonExtensionStep","MAWEBRestoreExtensionStep","MAWEncryptedBackupUtils","MAWLocalDBExtensionStep","MAWMessageIntegrityEBFetchStatus","MAWMessageRangeDataExternalObservables","MAWMessagesPaginationUtils","MAWMessagesRangesUtils","MAWPutMessagesToDB","MAWRangeExtensionDataConverter","MAWWaitForACTThreadReadyForMLv2","MLV2DataSourceLogger","MLV2RangeExtensionLogger","MessageRangeSet","Promise","ReQL","ReQLObservable","asyncToGeneratorRuntime","err","gkx","nullthrows","switchMap"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l=5,m=function(){function a(a,e){var f=this;this.$2=new(d("MessageRangeSet").MessageRangeSet)();this.$3=l;this.$4=!0;this.$5=new(d("MAWMessageRangeDataExternalObservables").MAWMessageRangeDataExternalObservables)();this.getOrCreateMessageRangeCoveringCursor=function(a,b,c){b==null?void 0:b.annotateMessageRangesDataSource("MAWMessageRangeDataSourceV2");b==null?void 0:b.markQPLPoint("maw_get_or_create_range_start");c=f.$2.getRangeForTimestamp(a.timestampMs);if(c!=null){b==null?void 0:b.markQPLPoint("maw_preexisting_range");b==null?void 0:b.markQPLPoint("maw_get_or_create_range_end");var e={maxExternalId:null,minExternalId:null};return f.$5.getOrCreateExternalObservableForRange(c,e)}c=(k||(k=d("I64"))).equal(a.timestampMs,k.max_int);e={hasMoreAfter:!c,hasMoreBefore:!0,isLoadingAfter:!1,isLoadingBefore:!1,maxMessageId:(e=a.messageId)!=null?e:"",maxTimestampMs:a.timestampMs,minMessageId:(c=a.messageId)!=null?c:"",minTimestampMs:a.timestampMs,threadKey:f.$1};c=f.$2.upsertRange(e);b==null?void 0:b.markQPLPoint("maw_range_created");b==null?void 0:b.markQPLPoint("maw_get_or_create_range_end");return f.$5.getOrCreateExternalObservableForRange(c,{maxExternalId:a==null?void 0:a.externalId,minExternalId:a==null?void 0:a.externalId})};this.$6=function(a){var b=d("MLV2DataSourceLogger").getMLV2LoggerForThread(f.$1,a),c=d("MLV2RangeExtensionLogger").getRangeExtensionLoggerForThread(f.$1,a);a={addQPLAnnotations:function(a){b==null?void 0:b.addQPLAnnotations(a),c==null?void 0:c.addQPLAnnotations(a)},annotateMessageRangesDataSource:function(a){b==null?void 0:b.annotateMessageRangesDataSource(a),c==null?void 0:c.annotateMessageRangesDataSource(a)},getInstanceKey:function(){var a;return(a=b==null?void 0:b.getInstanceKey())!=null?a:0},markQPLCancel:function(a){b==null?void 0:b.markQPLCancel(a),c==null?void 0:c.markQPLCancel(a)},markQPLFailure:function(a){b==null?void 0:b.markQPLFailure(a),c==null?void 0:c.markQPLFailure(a)},markQPLFailureWithMsg:function(a){b==null?void 0:b.markQPLFailureWithMsg(a),c==null?void 0:c.markQPLFailureWithMsg(a)},markQPLPoint:function(a,d){b==null?void 0:b.markQPLPoint(a,d),c==null?void 0:c.markQPLPoint(a,d)},markQPLSuccess:function(a){b==null?void 0:b.markQPLSuccess(a),c==null?void 0:c.markQPLSuccess()}};return a};this.extendRange=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c,e,g,i){var j=f.$6(e);j==null?void 0:j.annotateMessageRangesDataSource("MAWMessageRangeDataSourceV2");j==null?void 0:j.markQPLPoint("maw_v2_extend_range_start");var k=f.$2.getRangeForTimestamp(a.minTimestampMs);if(k==null){j==null?void 0:j.markQPLPoint("extend_range_canceled");return(h||(h=b("Promise"))).resolve()}var l=k.value;a=(yield d("MAWMessagesPaginationUtils").getMessagesRangesV2ExternalIdsIfChanged(a,l,c));if(e==="asc"&&(!l.hasMoreAfter||l.isLoadingAfter)){j==null?void 0:j.markQPLPoint("extend_range_canceled");return(h||(h=b("Promise"))).resolve()}if(e==="desc"&&(!l.hasMoreBefore||l.isLoadingBefore)){j==null?void 0:j.markQPLPoint("extend_range_canceled");return(h||(h=b("Promise"))).resolve()}c=f.$5.getOrCreateExternalObservableForRange(k,a);c.next({range:babelHelpers["extends"]({},l,{isLoadingAfter:l.isLoadingAfter||e==="asc",isLoadingBefore:l.isLoadingBefore||e==="desc"}),rangeExternalIds:a,type:"range_only"});return f.$7(k.value,a,c,e,g,i)["catch"](function(a){j==null?void 0:j.markQPLPoint("extend_range_failed");j==null?void 0:j.addQPLAnnotations({string:{range_extension_error:a instanceof Error?a.message:"unknown_error"}});throw a})});return function(b,c,d,e,f){return a.apply(this,arguments)}}();this.$7=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,g,j,k,l){var m=(yield (i||(i=d("LSDatabaseSingleton"))).LSDatabaseSingleton),n=f.$6(j);n==null?void 0:n.markQPLPoint("maw_wait_act_thread_start");var o=(yield d("MAWWaitForACTThreadReadyForMLv2").waitForACTThreadReadyForMLv2(m.tables,f.$1,"MAWMessageRangeDataSourceV2",n));o=o.chatJid;n==null?void 0:n.markQPLPoint("maw_wait_act_thread_end");var p=[{name:"local_fetch",step:c("MAWLocalDBExtensionStep")},{name:"eb_state_check",step:function(a){a=a.prevResponse;return f.isEBEnabled&&f.$4?(h||(h=b("Promise"))).resolve({extension:c("nullthrows")(a),status:"continue"}):(h||(h=b("Promise"))).resolve({extension:c("nullthrows")(a),status:"complete"})}},{name:"deanon_comparison",step:c("MAWDeanonComparisonExtensionStep")},{name:"eb_restore",step:d("MAWEBRestoreExtensionStep").createEBRestoreExtensionStep({onEBFailure:function(){f.$4=!1,d("MAWMessageIntegrityEBFetchStatus").recordEBFailure(f.$1)}})},{name:"fallback",step:function(a){a=a.prevResponse;return(h||(h=b("Promise"))).resolve({extension:c("nullthrows")(a),status:"complete"})}}],q=null;for(p of p){var r=p.name,s=p.step;s=(yield f.$8(s,r,{chatJid:o,count:k,db:m,direction:j,dispatch:l,logger:n,oldRange:a,oldRangeExternalIds:e,prevResponse:q},g));if(s.shouldTerminate)return;q=s.extension}});return function(b,c,d,e,f,g){return a.apply(this,arguments)}}();this.$8=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,g){var h=e.db,i=e.direction,j=e.dispatch,k=e.logger,l=e.oldRange,m=e.oldRangeExternalIds;k==null?void 0:k.markQPLPoint("maw_range_"+b+"_start");a=(yield a(e));k==null?void 0:k.markQPLPoint("maw_range_"+b+"_end");if(a.status==="try_again"){k==null?void 0:k.markQPLPoint("maw_range_"+b+"_retry");if(c("gkx")("7409")&&f.$3>0){k==null?void 0:k.markQPLPoint("maw_range_"+b+"_timed_out");f.$3-=1;g.next({range:babelHelpers["extends"]({},l,{isLoadingAfter:!1,isLoadingBefore:!1}),rangeExternalIds:m,type:"range_only"});return{shouldTerminate:!0}}throw c("err")("Timed out for step: "+b)}if(a.status==="complete"){k==null?void 0:k.markQPLPoint("insert_msgs_to_lsdb_start");yield d("MAWPutMessagesToDB").insertMessageResponseIntoDatabase(h,a.extension,j,k==null?void 0:k.getInstanceKey());k==null?void 0:k.markQPLPoint("insert_msgs_to_lsdb_end");k==null?void 0:k.markQPLPoint("maw_upsert_range_start");f.$9(l,m,g,i,a.extension);k==null?void 0:k.markQPLPoint("maw_upsert_range_end");return{shouldTerminate:!0}}if(a.status==="complete_with_range_override"){k==null?void 0:k.markQPLPoint("insert_msgs_to_lsdb_start");yield d("MAWPutMessagesToDB").insertMessageResponseIntoDatabase(h,a.extension,j,k==null?void 0:k.getInstanceKey());k==null?void 0:k.markQPLPoint("insert_msgs_to_lsdb_end");k==null?void 0:k.markQPLPoint("maw_upsert_range_start");f.$10(g,a.updatedRange,a.updatedRangeExternalIds);k==null?void 0:k.markQPLPoint("maw_upsert_range_end");return{shouldTerminate:!0}}return{extension:a.extension,shouldTerminate:!1}});return function(b,c,d,e){return a.apply(this,arguments)}}();this.$9=function(a,b,c,e,g){b=d("MAWMessagesRangesUtils").mergeMoreMessagesResponseIntoRange(a,b,g,e);e=b[0];b=b[1];g=d("MAWRangeExtensionDataConverter").convertLocalResponseToMessages(f.$1,g);a=(k||(k=d("I64"))).equal(a.minTimestampMs,a.maxTimestampMs)&&a.maxMessageId===a.minMessageId;f.$10(c,e,b,{coverEntireRange:a,messages:g})};this.$1=a;this.isEBEnabled=e}var e=a.prototype;e.$10=function(a,b,c,d){b=this.$2.upsertRange(b);d!=null?a.next({prefetchedData:d,range:b.value,rangeExternalIds:c,type:"range_with_prefetched_messages"}):a.next({range:b.value,rangeExternalIds:c,type:"range_only"})};return a}(),n=function(){function a(a){var b=this;this.$1=new Map();this.getOrCreateMessageRangeCoveringCursor=function(a,d,e){var f=a.threadKey;return c("switchMap")(b.$2,function(c){return b.$3(f,c).getOrCreateMessageRangeCoveringCursor(a,d,e)})};this.extendRange=function(a,e,f,g,h){var i=a.threadKey,j=d("MLV2RangeExtensionLogger").startRangeExtensionLoggerForThread(i,f,a,g);return c("nullthrows")(b.$1.get((k||(k=d("I64"))).to_string(i))).extendRange(a,e,f,g,h).then(function(){j.markQPLSuccess()})["catch"](function(a){j.markQPLFailure(a);throw a})};this.$2=d("ReQLObservable").create(a,function(){return d("ReQL").fromTableAscending(a.tables.secure_encrypted_backups_client_state).take(1).map(function(a){var b=d("MAWEncryptedBackupUtils").getBackupTenancyFromClientStateRow(a);b!=null&&a.backupTenancy==null&&c("FBLogger")("messenger_web_product").warn("Previously broken state of invalid backup tenancy is caught");return b!=null&&(k||(k=d("I64"))).equal(b,(j||(j=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsBackupTenancy").PRODUCTION))})}).map(function(a){return Boolean(a==null?void 0:(a=a[0])==null?void 0:a[1])})}var b=a.prototype;b.$3=function(a,b){var e=(k||(k=d("I64"))).to_string(a);if(!this.$1.has(e)){var f=new m(a,b);this.$1.set(e,f)}f=c("nullthrows")(this.$1.get(e));f.isEBEnabled!==b&&(f=new m(a,b),this.$1.set(e,f));return f};return a}(),o,p;function a(a){(o==null||p!==a)&&(p=a,o=new n(a));return o}g["default"]=a}),98);